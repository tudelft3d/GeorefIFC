<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIMserver Login</title>
</head>
<body>
    <h1>Logging in to BIMserver...</h1>

    <script>
        const clientId = '473:6536781D-C8A0-4B55-998C-B5C9D588A177';
        const clientSecret = 'E1F0FE2E-009D-48A7-8042-443C2EE3C8F3';
        const scope = [
            "DATA_USER_READ",
            "PROJECTS_USER_READ",
            "PROJECTS_USER_WRITE",
            "CONTRIBUTIONS_USER_READ",
            "CONTRIBUTIONS_USER_WRITE"
        ];

        // Function to get query parameters from the URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Function to retrieve the session token using session_temp
        function retrieveSessionToken(sessionTemp) {
            fetch(`https://apis.bimserver.center/v1/BIMSERVER/LOGIN/${sessionTemp}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(sessionData => {
                console.log('Session Data:', sessionData);  // Log the session data response
                const sessionId = sessionData.session_id;
                if (sessionId) {
                    localStorage.setItem('sessionId', sessionId); // Save session ID to local storage
                    console.log("Session ID saved. Closing window...");

                    // Delay to ensure session ID is saved before closing the window
                    setTimeout(() => {
                        window.opener.location.reload(); // Refresh the main page
                        window.close(); // Close the login popup
                    }, 500); // 500 ms delay to ensure local storage is complete
                } else {
                    console.error("Failed to retrieve session ID.");
                }
            })
            .catch(error => console.error('Error retrieving session token:', error));
        }

        // Initiate authentication process
        window.onload = () => {
            const sessionTemp = getQueryParam('session_temp');

            if (sessionTemp) {
                console.log('Session Temp:', sessionTemp);  // Log the session_temp
                // If session_temp is present in URL, retrieve session token
                retrieveSessionToken(sessionTemp);
            } else {
                // Step 1: Request a temporary token and redirect to authorization
                fetch('https://apis.bimserver.center/v1/BIMSERVER/login?lang_interface=en', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        scope: scope
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Temporary Token Response:', data);  // Log the initial token response
                    const authorizationUrl = data.url;
                    window.location.href = authorizationUrl; // Redirect to authorization URL
                })
                .catch(error => console.error('Error:', error));
            }
        };
    </script>
</body>
</html>