<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIMserver Projects Information</title>
    <style>
        .project-box {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .project-box h2 {
            margin: 0;
        }
        .select-button {
            margin-top: 10px;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .select-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<h1>Retrieve BIMserver Projects</h1>
<div id="projects"></div>

<script>
    async function getProjects() {
        const clientId = '473:6536781D-C8A0-4B55-998C-B5C9D588A177';
        const clientSecret = 'E1F0FE2E-009D-48A7-8042-443C2EE3C8F3';
        const scope = [
            "DATA_USER_READ",
            "PROJECTS_USER_READ",
            "PROJECTS_USER_WRITE",
            "CONTRIBUTIONS_USER_READ",
            "CONTRIBUTIONS_USER_WRITE"
        ];

        try {
            // Step 1: Request temporary session token
            const loginResponse = await fetch('https://apis.bimserver.center/v1/BIMSERVER/LOGIN', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: clientId,
                    client_secret: clientSecret,
                    scope: scope
                })
            });

            const loginData = await loginResponse.json();
            if (loginData.status === "OK") {
                const authWindow = window.open(loginData.url, '_blank', 'width=600,height=400');
                await new Promise((resolve, reject) => {
                    const interval = setInterval(() => {
                        if (authWindow.closed) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 1000);
                });

                const sessionTemp = loginData.session_temp;
                const security_id = loginData.security_id;
                const sessionResponse = await fetch(`https://apis.bimserver.center/v1/BIMSERVER/LOGIN/${sessionTemp}?security_id=${security_id}&lang_interface=en`, {
                    method: 'GET'    
                });
                const sessionData = await sessionResponse.json();

                if (sessionData.status === "OK") {
                    const sessionId = sessionData.session_id;

                    const projectsResponse = await fetch('https://apis.bimserver.center/v1/BIMSERVER/PROJECTS', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${sessionId}`
                        }
                    });

                    const projectsData = await projectsResponse.json();
                    if (projectsData.status === "OK") {
                        displayProjects(projectsData.records);
                    } else {
                        console.error("Error fetching projects:", projectsData.error.message);
                    }
                } else {
                    console.error("Error fetching session token:", sessionData.error.message);
                }
            } else {
                console.error("Error logging in:", loginData.error.message);
            }
        } catch (error) {
            console.error("Request failed:", error);
        }
    }

    function displayProjects(projects) {
        const projectsDiv = document.getElementById('projects');
        projectsDiv.innerHTML = ""; // Clear previous content if any

        projects.forEach(project => {
            const projectElement = document.createElement('div');
            projectElement.className = 'project-box';
            projectElement.innerHTML = `
                <h2>${project.name}</h2>
                <p>ID: ${project.id}</p>
                <p>Description: ${project.description}</p>
                <button class="select-button" onclick="selectProject('${project.id}')">Select Project</button>
            `;
            projectsDiv.appendChild(projectElement);
        });
    }

    function selectProject(projectId) {
        console.log("Selected Project ID:", projectId);
        // Alternatively, display it on the page
        alert(`Selected Project ID: ${projectId}`);
    }

    getProjects();
</script>

</body>
</html>